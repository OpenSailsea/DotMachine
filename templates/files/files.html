{% extends "base.html" %}

{% block title %}æ–‡ä»¶ç®¡ç† - DotMachine{% endblock %}

{% block head %}
{{ super() }}
<!-- Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
<style>
.file-list {
    height: calc(100vh - 300px);
    overflow-y: auto;
}
.file-editor {
    height: calc(100vh - 300px);
    display: none;
}
#editor {
    width: 100%;
    height: 100%;
}
.breadcrumb {
    display: flex;
    flex-wrap: wrap;
    padding: 0.5rem 1rem;
    margin-bottom: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
}
.breadcrumb-item {
    cursor: pointer;
    color: #3b82f6;
}
.breadcrumb-item:hover {
    text-decoration: underline;
}
.breadcrumb-item + .breadcrumb-item::before {
    content: "/";
    padding: 0 0.5rem;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">æ–‡ä»¶ç®¡ç†</h1>
            <div class="flex space-x-4">
                <button onclick="showUploadDialog()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    ä¸Šä¼ æ–‡ä»¶
                </button>
                <button onclick="showCreateFolderDialog()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    æ–°å»ºæ–‡ä»¶å¤¹
                </button>
                <a href="{{ url_for('system.dashboard', container_id=container_id) }}" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    è¿”å›ç®¡ç†é¢æ¿
                </a>
            </div>
        </div>
        
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <div class="breadcrumb mb-4" id="breadcrumb"></div>
        
        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="file-list" id="file-list">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç§°</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¤§å°</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æƒé™</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¿®æ”¹æ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="file-list-body"></tbody>
            </table>
        </div>
        
        <!-- æ–‡ä»¶ç¼–è¾‘å™¨ -->
        <div class="file-editor" id="file-editor">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold" id="editor-filename"></h2>
                <div class="flex space-x-4">
                    <button onclick="saveFile()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        ä¿å­˜
                    </button>
                    <button onclick="closeEditor()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        å…³é—­
                    </button>
                </div>
            </div>
            <div id="editor"></div>
        </div>
    </div>
</div>

<!-- ä¸Šä¼ æ–‡ä»¶å¯¹è¯æ¡† -->
<div class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden" id="upload-dialog">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">ä¸Šä¼ æ–‡ä»¶</h3>
            <div class="mt-2 px-7 py-3">
                <input type="file" id="file-input" class="w-full">
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="uploadFile()" class="px-4 py-2 bg-blue-500 text-white rounded mr-2 hover:bg-blue-600">
                    ä¸Šä¼ 
                </button>
                <button onclick="closeUploadDialog()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å»ºæ–‡ä»¶å¤¹å¯¹è¯æ¡† -->
<div class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden" id="create-folder-dialog">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">æ–°å»ºæ–‡ä»¶å¤¹</h3>
            <div class="mt-2 px-7 py-3">
                <input type="text" id="folder-name" class="w-full px-3 py-2 border rounded" placeholder="æ–‡ä»¶å¤¹åç§°">
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="createFolder()" class="px-4 py-2 bg-blue-500 text-white rounded mr-2 hover:bg-blue-600">
                    åˆ›å»º
                </button>
                <button onclick="closeCreateFolderDialog()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPath = '/data';
let editor = null;
let currentFile = null;
const containerId = '{{ container_id }}';

// åˆå§‹åŒ–Monacoç¼–è¾‘å™¨
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
require(['vs/editor/editor.main'], function() {
    editor = monaco.editor.create(document.getElementById('editor'), {
        value: '',
        language: 'plaintext',
        theme: 'vs-dark',
        automaticLayout: true
    });
});

// åŠ è½½æ–‡ä»¶åˆ—è¡¨
function loadFiles(path = '/data') {
    currentPath = path;
    updateBreadcrumb();
    
    fetch(`/files/list?container_id=${containerId}&path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            const tbody = document.getElementById('file-list-body');
            tbody.innerHTML = '';
            
            data.files.forEach(file => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-900 ${file.type === 'd' ? 'cursor-pointer hover:text-blue-600' : ''}"
                                  onclick="${file.type === 'd' ? `loadFiles('${path}/${file.name}')` : `openFile('${path}/${file.name}')`}">
                                ${file.type === 'd' ? 'ğŸ“ ' : 'ğŸ“„ '}${file.name}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.size}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.permissions}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.modified}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${file.type === 'f' ? `
                            <a href="/files/download?container_id=${containerId}&path=${encodeURIComponent(path + '/' + file.name)}" 
                               class="text-indigo-600 hover:text-indigo-900 mr-4">ä¸‹è½½</a>
                        ` : ''}
                        <a href="#" onclick="deleteItem('${path}/${file.name}')" class="text-red-600 hover:text-red-900">åˆ é™¤</a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });
}

// æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
function updateBreadcrumb() {
    const parts = currentPath.split('/').filter(p => p);
    let html = '<span class="breadcrumb-item" onclick="loadFiles(\'/data\')">æ ¹ç›®å½•</span>';
    let path = '/data';
    
    parts.forEach(part => {
        path += '/' + part;
        html += `<span class="breadcrumb-item" onclick="loadFiles('${path}')">${part}</span>`;
    });
    
    document.getElementById('breadcrumb').innerHTML = html;
}

// æ‰“å¼€æ–‡ä»¶
function openFile(path) {
    fetch(`/files/read?container_id=${containerId}&path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            document.getElementById('file-list').style.display = 'none';
            document.getElementById('file-editor').style.display = 'block';
            document.getElementById('editor-filename').textContent = path.split('/').pop();
            
            currentFile = path;
            editor.setValue(data.content);
            
            // æ ¹æ®æ–‡ä»¶æ‰©å±•åè®¾ç½®è¯­è¨€
            const ext = path.split('.').pop().toLowerCase();
            const langMap = {
                'js': 'javascript',
                'py': 'python',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'md': 'markdown',
                'php': 'php',
                'sh': 'shell',
                'sql': 'sql',
                'xml': 'xml',
                'yaml': 'yaml',
                'yml': 'yaml'
            };
            editor.setModelLanguage(editor.getModel(), langMap[ext] || 'plaintext');
        });
}

// ä¿å­˜æ–‡ä»¶
function saveFile() {
    const formData = new FormData();
    formData.append('container_id', containerId);
    formData.append('path', currentFile);
    formData.append('content', editor.getValue());
    
    fetch('/files/write', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('ä¿å­˜æˆåŠŸ');
        }
    });
}

// å…³é—­ç¼–è¾‘å™¨
function closeEditor() {
    document.getElementById('file-list').style.display = 'block';
    document.getElementById('file-editor').style.display = 'none';
    currentFile = null;
}

// æ˜¾ç¤ºä¸Šä¼ å¯¹è¯æ¡†
function showUploadDialog() {
    document.getElementById('upload-dialog').classList.remove('hidden');
}

// å…³é—­ä¸Šä¼ å¯¹è¯æ¡†
function closeUploadDialog() {
    document.getElementById('upload-dialog').classList.add('hidden');
    document.getElementById('file-input').value = '';
}

// ä¸Šä¼ æ–‡ä»¶
function uploadFile() {
    const fileInput = document.getElementById('file-input');
    if (!fileInput.files.length) {
        alert('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
    }
    
    const formData = new FormData();
    formData.append('container_id', containerId);
    formData.append('path', currentPath);
    formData.append('file', fileInput.files[0]);
    
    fetch('/files/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            closeUploadDialog();
            loadFiles(currentPath);
        }
    });
}

// æ˜¾ç¤ºæ–°å»ºæ–‡ä»¶å¤¹å¯¹è¯æ¡†
function showCreateFolderDialog() {
    document.getElementById('create-folder-dialog').classList.remove('hidden');
}

// å…³é—­æ–°å»ºæ–‡ä»¶å¤¹å¯¹è¯æ¡†
function closeCreateFolderDialog() {
    document.getElementById('create-folder-dialog').classList.add('hidden');
    document.getElementById('folder-name').value = '';
}

// åˆ›å»ºæ–‡ä»¶å¤¹
function createFolder() {
    const name = document.getElementById('folder-name').value.trim();
    if (!name) {
        alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
        return;
    }
    
    const formData = new FormData();
    formData.append('container_id', containerId);
    formData.append('path', currentPath);
    formData.append('name', name);
    
    fetch('/files/create_folder', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            closeCreateFolderDialog();
            loadFiles(currentPath);
        }
    });
}

// åˆ é™¤æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
function deleteItem(path) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('container_id', containerId);
    formData.append('path', path);
    
    fetch('/files/delete', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            loadFiles(currentPath);
        }
    });
}

// åˆå§‹åŒ–åŠ è½½
document.addEventListener('DOMContentLoaded', function() {
    loadFiles();
});
</script>
{% endblock %}
